name: Daily Weather Logger

on:
  schedule:
    # runs daily at 00:05 UTC (adjust as you like)
    - cron: "23 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  log-weather:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch weather & append CSV
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
          LAT: "-17.8292"      # Harare approx
          LON: "31.0522"
        run: |
          set -euo pipefail
          mkdir -p data
          OUTFILE="data/weather.csv"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          API_URL="https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&units=metric&appid=${WEATHER_API_KEY}"

          # Fetch and capture HTTP status separately
          HTTP_CODE=$(curl -sS -w "%{http_code}" -o /tmp/resp.json "$API_URL")

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "HTTP error: $HTTP_CODE"
            echo "Body:"
            cat /tmp/resp.json || true
            exit 1
          fi

          # Some responses return cod as number or string; normalize
          COD=$(jq -r '.cod | tostring // "200"' /tmp/resp.json)
          if [ "$COD" != "200" ]; then
            echo "OpenWeather error cod=$COD message=$(jq -r '.message // "unknown error"' /tmp/resp.json)"
            exit 1
          fi

          TEMP=$(jq -r '.main.temp // empty' /tmp/resp.json)
          WEATHER_DESC=$(jq -r '.weather[0].description // empty' /tmp/resp.json)
          HUMIDITY=$(jq -r '.main.humidity // empty' /tmp/resp.json)
          WIND=$(jq -r '.wind.speed // empty' /tmp/resp.json)

          # Sanity check to avoid writing empty rows
          if [ -z "${TEMP}" ] || [ -z "${WEATHER_DESC}" ]; then
            echo "Parsed fields missing; response was:"
            cat /tmp/resp.json
            exit 1
          fi

          # Header if file missing
          if [ ! -f "$OUTFILE" ]; then
            echo "timestamp_iso,city,country,temp_c,weather,humidity,wind_m_s,raw_json_source" > "$OUTFILE"
          fi

          SAFE_WEATHER=$(printf "%s" "$WEATHER_DESC" | sed 's/,/;/g')
          CITY=$(jq -r '.name // "Harare"' /tmp/resp.json)
          COUNTRY=$(jq -r '.sys.country // "ZW"' /tmp/resp.json)

          # Do NOT store the API key in the CSV; just note source type
          echo "${TIMESTAMP},${CITY},${COUNTRY},${TEMP},\"${SAFE_WEATHER}\",${HUMIDITY},${WIND},openweathermap_current" >> "$OUTFILE"
      
      - name: Commit and push changes
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          AUTHOR_NAME: ${{ secrets.AUTHOR_NAME }}
          AUTHOR_EMAIL: ${{ secrets.AUTHOR_EMAIL }}
        run: |
          set -euo pipefail
          git config user.name "${AUTHOR_NAME}"
          git config user.email "${AUTHOR_EMAIL}"

          # Only commit if there are changes
          if git status --porcelain | grep -q .; then
            git add data/weather.csv
            git commit -m "chore(weather): append weather for $(date -u +'%Y-%m-%d')"
            # push with PAT so commit is attributed to your account
            REPO_URL="$(git remote get-url origin)"
            # use token auth for push
            AUTH_URL=$(echo "$REPO_URL" | sed -E "s#https://(.*)@?github.com/#https://x-access-token:${GH_PAT}@github.com/#; t; s#https://#https://x-access-token:${GH_PAT}@#")
            git push "$AUTH_URL" HEAD:$(git rev-parse --abbrev-ref HEAD)
          else
            echo "No changes to commit"
          fi
