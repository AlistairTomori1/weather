name: Daily Weather Logger

on:
  schedule:
    # runs daily at 00:05 UTC (adjust as you like)
    - cron: "5 0 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  log-weather:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch weather & append CSV
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
          CITY: "Harare"
          COUNTRY_CODE: "ZW"
        run: |
          set -euo pipefail
          mkdir -p data
          OUTFILE="data/weather.csv"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          API_URL="https://api.openweathermap.org/data/2.5/weather?q=${CITY},${COUNTRY_CODE}&units=metric&appid=${WEATHER_API_KEY}"

          # Request JSON
          RESPONSE=$(curl -sS "${API_URL}")

          # Quick check
          if echo "$RESPONSE" | jq -e '.cod // 200' >/dev/null 2>&1; then
            :
          else
            echo "Weather API returned error:"
            echo "$RESPONSE"
            exit 1
          fi

          # parse fields (change/add fields as you like)
          TEMP=$(echo "$RESPONSE" | jq -r '.main.temp // empty')
          WEATHER_DESC=$(echo "$RESPONSE" | jq -r '.weather[0].description // empty')
          HUMIDITY=$(echo "$RESPONSE" | jq -r '.main.humidity // empty')
          WIND=$(echo "$RESPONSE" | jq -r '.wind.speed // empty')

          # If file missing, add header
          if [ ! -f "$OUTFILE" ]; then
            echo "timestamp_iso,city,country,temp_c,weather,humidity,wind_m_s,raw_json_url" > "$OUTFILE"
          fi

          # Append CSV row (escape commas in description)
          SAFE_WEATHER=$(echo "$WEATHER_DESC" | sed 's/,/;/g')
          RAW_URL="data:application/json;$(echo "$RESPONSE" | jq -c '.')"
          echo "${TIMESTAMP},${CITY},${COUNTRY_CODE},${TEMP},\"${SAFE_WEATHER}\",${HUMIDITY},${WIND},${API_URL}" >> "$OUTFILE"

      - name: Commit and push changes
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          AUTHOR_NAME: ${{ secrets.AUTHOR_NAME }}
          AUTHOR_EMAIL: ${{ secrets.AUTHOR_EMAIL }}
        run: |
          set -euo pipefail
          git config user.name "${AUTHOR_NAME}"
          git config user.email "${AUTHOR_EMAIL}"

          # Only commit if there are changes
          if git status --porcelain | grep -q .; then
            git add data/weather.csv
            git commit -m "chore(weather): append weather for $(date -u +'%Y-%m-%d')"
            # push with PAT so commit is attributed to your account
            REPO_URL="$(git remote get-url origin)"
            # use token auth for push
            AUTH_URL=$(echo "$REPO_URL" | sed -E "s#https://(.*)@?github.com/#https://x-access-token:${GH_PAT}@github.com/#; t; s#https://#https://x-access-token:${GH_PAT}@#")
            git push "$AUTH_URL" HEAD:$(git rev-parse --abbrev-ref HEAD)
          else
            echo "No changes to commit"
          fi
